---
layout: post
title: 랩뷰 통신 문제
date: 2018-11-22 18:40:00 +0900
author: 원성규
excerpt: 
categories:
- labview
tags: 
- labview
- gps
keyworkds:
---

랩뷰에서 GPS 수신기를 읽어서 좌표 정보를 화면에 출력하는 과정에서 발생한 프로그램 구성 오류와 해결 과정을 아래에 기록한다.

### 랩뷰 루프 딜레이

CPU 사용률이 0에 가까운 상태에서 랩뷰 루프가 늘어지고 있다. 
시간이 지날수록 루프당 화면 갱신 시간이 1초에 10회에서 5초에 1회가 되었다.
의심되는 부분은 쉬프트레지스터에 거대한 클러스터를 등록한 것이다.
프로젝트를 복사하여 거대 클러스터를 최대한 없애봐야겠다.

### 문제 상황 분석

현재 랩뷰 GPS 코드는 시리얼포트의 정보를 모두 모으는 예제에 NMEA 구문 분석기를 붙인 것이다. 
거기에 스카이플롯과 구글맵스 자바스크립트 페이지를 붙이고 모듈화하였다. 
그런데 시간이 지날수록 루프가 느려졌다. 
이 느려짐은 경험에 비추어보았을 때 대규모 메모리를 계속 들고 이동하거나 카피할 때 나타나는 현상이다.
모듈을 하나씩 비활성화하면서 루프의 반응을 살펴보았고 과거에 남은 코드의 반응과 애초에 참조코드를 다시 열었다.

### NMEA 모듈 조사

NMEA 모듈 라이브러리의 기능을 보충하여 사용하면서도 몰랐었는데 1.2 버전에 압축파일 안에는 완전한 사용 예제가 있었다. 
이 예제에서 전체 구조는 시리얼포트에서 읽은 메시지를 큐에 넣으면서 시작한다.
그리고 정보 분석을 할 때 이미 처리된 메모리는 큐에서 삭제될 것이다.
현재 내 코드에서는 큐를 사용하지 않고 쉬프트레지스터에 등록된 문자열에 모든 입력 메시지가 쌓이고 있다. 
그리고 구문처리를 모듈화하였는데 큐에 해당하는 문자열 덩어리를 넣었을 때 복사되고 있었을 가능성이 있다. (subvi 인자가 복사냐 참조냐의 문제)

내 코드에서는 처음부터 누적되어 커지고 있는 메시지 덩어리를 매번 분석하고 그중에서 마지막으로 업데이트된  메시지를 보여주었을 것이다.
처음에는 실시간으로 처리되면서 새로 입력된 GPS 메시지를 분석해서 보여준 것으로 보이겠지만
시간이 갈수록 제일 처음 처리했던 메시지는 매번 반복해서 다시 처리되었고 덮어쓰면서 사라지고 마지막 메시지가 보이는 것이다.

따져보니 문자열을 전달받은 그어떤 모듈 또는 코드도 그것을 변조한 결과물을 리턴하기 전에는 원본 메시지에 영향을 줄 수 없다. 
결론적으로 현재 내 문제의 핵심은 큐를 사용하지 않은 것으로 보인다.

### 큐를 사용

랩뷰에서 큐를 사용하여 안정적으로 GPS 신호를 읽게 되었다.

### 통신 주기 문제

시리얼포트를 100ms 간격으로 읽으면 GPGGA 메시지가 꺠지는 현상이 생겼다.
시간 간격을 500ms로 늘리자 정상적으로 문장을 인식하여 약 1초에 한문장을 읽었다.
문장의 시작 문자($)와 끝 문자(\n) 사이를 찾아서 존재하면 처리루틴으로 넘긴다.
그런데 시리얼포트를 자주 읽으면 특별히 GPGGA 메시지는 문장의 초반 일부만 나타나는 현상 보였다.
일단 처리기로 넘어와서 체크섬을 통과하지 못하여 많은 문자열이 소멸되었다. 
그러다가 간혹 완전한 문장이 입력되면 로그에 기록되곤 하였다.

이런 현상의 원인은 패턴을 체크하여 처리루틴으로 들어온 메시지가 가짜 끝문자를 가지고 있기 때문이라고 의심할 수 있다.
문장이 불완전한 것은 프루브로 직접 관찰한 결과이며 특별히 GPGGA 문장만 그러하다.
그리고 이 문장이 처리기에 들어왔으니 패턴 검사는 통과한 것이다. 따라서 자동으로 끝문자가 붙지 않았다면 일어날 수 없는 일인 것이다.

### 통신 두절 문제

체크섬을 통과하기 전에 프루브를 읽었는데 오후 시간대에 GPGGA가 10초 이상 신호가 들어오지 않는 경우가 있었다.
이제 정상적으로 신호를 받는다고 가정했을 떄 GPGGA 메시지 로그를 보면 10초간 1초에 한번씩 기록되었다가 20여초간 끊겼다가 다시 10여초간 기록이 이어지는 현상이 자주 발생한다.

기록이 끊어진 시점에 GPS 시각과 그것이 인디케이터에 나타난 현재 시각이 맞지 않고 그리고 계속 그 간격이 벌어지고 있는 것이 이상하다.
이 현상은 큐를 사용하지 않고 프로그램을 구성했을 때와 비슷하다. 
동시에 GNRMC의 GPS 기록시각은 현재시각과 비슷하게 맞다.

### GPGGA 메시지 문제

시리얼포트 읽는 주기가 길건 짧건 다른 문장은 정상적으로 인식되는데 GPGGA만 문장이 짤려서 들어온다. 특히 자주 읽으면 거의 확시하게 문장이 짤린다.
메시지 처리 코드의 공통단자에 서 읽었으므로 다른 메시지와의 차이 또는 특이성은 없다.

GPGGA 외에 다른 신호는 느리건 빠르건 메시지가 깨지는 현상이 보이지 않았으며 특히 GPGSV와 GLGSV는 최대 2~3문장씩 총 5~6문장이 반드시 이어서 입력되었다.


### 통신 메시지 처리 과정 고찰

주기가 길건 짧건 시리얼포트에서 충분한 양을 읽어서 부지런히 통신 버퍼를 비운다. 
가져온 메시지는 용량이 충분한 큐에 입력되며 이과정에서 쉬프트 레지스터가 사용된다.
큐에서 원소를 얻어와서 메시지를 처리할 때는 큐에 차있는 모든 데이타를 가져오는 것으로 보인다.
통신 버퍼는 비워오기만 하면 이후의 과정은 그 버퍼의 크기와는 상관이 없다.
가져온 큐는 메시지 처리기에 들어간다. 문장이 완성되지 않아서 남은 문자열은 쉬프트레지스터에서 돌게 된다.
이제 쉬프트레지스터에 그다음 큐 원소가 입력되면 어떻게 될까? 이어서 문자열을 추가할까 아니면 덮어쓰게 될까. 모르겠다.


### 안정 조건

시리얼 포트 읽기 주기를 100ms 메시지 처리 주기를 10ms로 결정하면 초당 7~10 메시지를 처리하는 것으로 보이며 안정되어 보인다.
이 설정에서 내가 추가한 메시지 끝문자 처리 코드는 별 영향을 주지 않는 것으로 보인다.
시리얼 포트 읽기 주기를 10ms 이하로 낮추면 조각 문자열이 큐에 들어가고 메시지 처리 루틴이 조각 문자열을 처리하지는 못했다.
쉬프트레지스터에 큐 원소가 입력될 때의 정확한 동작을 알아야 이 부분이 명확해질 것이다.

현재 GPS를 통신에 적절한 설정은 다음과 같다.

| 주기 | 시간(ms) |
|-----|---------|
| 시리얼포트 | 100 |
| 메시지 분석 주기 | 10ms |
| 파일 로그 주기 | 1000~5000 |
| 스카이플롯 주기 | 5000 |

### 통신 상태 관찰

GPGGA의 입력 주기가 오전에 1초이고 저녁에 5초이다.
현재 위경도를 읽으려면 GPGGA 보다 GNRMC가 유리하다.
GPRMC는 전혀 안들어오는 줄 알았는데 약 두 시간전에 입력된 기록이 있다.
시리얼포트 주기를 10ms 까지 줄여도 GPGGA를 제외한 다른 메시지는 완전한 문장이 입력된다.
GPGSV와 GLGSV는 그룹 정보가 연달아 입력되며 두 메시지도 이어서 입력된다.
조사된 7가지 메시지가 모두 한번씩은 입력되었다. 몇몇 종류의 메시지는 전혀 입력되지 않는 줄 
알았다.

### 요약

랩뷰에서 안정적인 시리얼 통신을 하기 위해서 큐를 사용해야 한다.
그리고 메시지를 수신하는 사이에 적당한 시간간격을 주어야 한다.
메시지 수신을 확인하는 회신 과정이 숨어있어서 작업이 완료되기까지 충분한 시간간격이 필요하다더라.

